<script>
// === 八宅對照（你原本若已定義 FIELD 會沿用這個外的，不會覆寫） ===
if(typeof FIELD==="undefined"){
  window.FIELD={
    11:"伏位",19:"延年",14:"生氣",13:"天醫",17:"禍害",16:"六煞",12:"絕命",18:"五鬼",
    22:"伏位",26:"延年",28:"生氣",27:"天醫",23:"禍害",29:"六煞",21:"絕命",24:"五鬼",
    33:"伏位",34:"延年",39:"生氣",31:"天醫",32:"禍害",38:"六煞",37:"絕命",36:"五鬼",
    44:"伏位",43:"延年",41:"生氣",49:"天醫",46:"禍害",47:"六煞",48:"絕命",42:"五鬼",
    66:"伏位",62:"延年",67:"生氣",68:"天醫",64:"禍害",61:"六煞",69:"絕命",63:"五鬼",
    77:"伏位",78:"延年",76:"生氣",72:"天醫",71:"禍害",74:"六煞",73:"絕命",79:"五鬼",
    88:"伏位",87:"延年",82:"生氣",86:"天醫",89:"禍害",83:"六煞",84:"絕命",81:"五鬼",
    99:"伏位",91:"延年",93:"生氣",94:"天醫",98:"禍害",92:"六煞",96:"絕命",97:"五鬼",
  };
}

// 字母對應 11 表（A=11, B=12 ... I=19, J=21 ...）
function letterTo11(ch){
  const code=ch.toUpperCase().charCodeAt(0);
  if(code<65||code>90) return null;
  const n=code-64; // A=1
  const tens = Math.floor((n-1)/9) + 1;
  const ones = ((n-1)%9) + 1;
  return `${tens}${ones}`; // A=11, B=12, ... I=19, J=21 ...
}

// 取 radio 值
function getRadio(name){ const el=document.querySelector(`input[name="${name}"]:checked`); return el?el.value:null; }

// 除錯核心：回傳 {pairs, steps}
function buildDebugSteps(input, rule0, rule5, ruleA){
  const s=(input||"").toUpperCase().replace(/\s+/g,"");
  const steps=[], pairs=[];
  if(!s) return {pairs,steps};

  // 起始 pair（字母）
  let initPair="";
  if(/[A-Z]/.test(s[0])){
    initPair = (ruleA==='10') ? "10" : (letterTo11(s[0])||"11");
  }else if(/[0-9]/.test(s[0])){
    // 純數字：以首碼重複起頭（與你現有純數字規則一致）
    initPair = s[0]+s[0];
  }else{
    initPair="11";
  }
  pairs.push(initPair);
  let prev = initPair[1];

  // 逐字處理
  for(let i=1;i<s.length;i++){
    const ch=s[i];
    if(!/[0-9]/.test(ch)) continue;

    const beforePrev = prev;
    let usedChar = ch;
    let second = null;
    let consumed = false;
    let peeked   = false;

    if(ch==='0'){
      if(rule0==='00'){
        pairs.push('00');
        steps.push({i, char:ch, beforePrev, afterPrev:prev, peek:false, consume:false, pair:'00', name:FIELD['00']||'—'});
        continue; // prev 不動
      }else{
        second = beforePrev; // repeat
        // prev 不動
      }
    }else if(ch==='5'){
      const next = (i+1<s.length && /\d/.test(s[i+1])) ? s[i+1] : beforePrev;
      if(rule5==='peek'){
        second = next;       // 看下一碼，但不吃
        peeked = true;
        // prev 不動
      }else{ // consume
        second = next;
        consumed = (next!==beforePrev); // 有真吃到下一碼才算
        if(consumed) { prev = next; i++; } // 吃掉下一碼且前進
      }
    }else{
      second = ch; // 正常數字
      prev = ch;
    }

    const pair = (second==null) ? (beforePrev+beforePrev) : (beforePrev + second);
    pairs.push(pair);
    steps.push({
      i, char:usedChar, beforePrev, afterPrev:prev,
      peek:peeked, consume:consumed, pair, name:FIELD[pair]||'—'
    });
  }

  return {pairs,steps};
}

// 渲染表
function renderDebug(input, pairs, steps){
  const rows = steps.map(s=>`
    <tr>
      <td>${s.i}</td>
      <td>${s.char}</td>
      <td>${s.beforePrev}</td>
      <td>${s.afterPrev}</td>
      <td>${s.peek?'✓':''}</td>
      <td>${s.consume?'✓':''}</td>
      <td>${s.pair}</td>
      <td>${s.name}</td>
    </tr>`).join('');

  document.getElementById('debugTable').innerHTML = `
    <div class="muted">輸入：<code>${input||'（空）'}</code></div>
    <table>
      <thead><tr>
        <th>#</th><th>字</th><th>prev(前)</th><th>prev(後)</th>
        <th>peek</th><th>eat</th><th>pair</th><th>命名</th>
      </tr></thead>
      <tbody>${rows||'<tr><td colspan="8" class="muted">—</td></tr>'}</tbody>
    </table>
    <div style="margin-top:8px" class="muted">最後 pair 串列：<code>${JSON.stringify(pairs)}</code></div>
  `;
}

// 事件：開關面板
document.getElementById('debugToggle').addEventListener('click', ()=>{
  const p=document.getElementById('debugPanel');
  p.style.display = (p.style.display==='none' || !p.style.display) ? 'block' : 'none';
});

// 提供給你的主流程呼叫：把「使用者輸入的原字串」塞進來即可
window.runDebugIfOpen = function(rawInput){
  const panel = document.getElementById('debugPanel');
  if(!panel || panel.style.display!=='block') return;

  const r0 = getRadio('r0') || 'repeat';
  const r5 = getRadio('r5') || 'peek';
  const rA = getRadio('rA') || '11';

  const {pairs,steps} = buildDebugSteps(rawInput, r0, r5, rA);
  renderDebug(rawInput, pairs, steps);
};
</script>
