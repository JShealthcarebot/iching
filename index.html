<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>[ 易經數字｜純數字版 ]</title>
<meta name="theme-color" content="#23b6af">
<style>
  :root{
    --bg:#e9fbf8;--card:#fff;--text:#0f2a26;--muted:#5e7b75;--accent:#23b6af;
    --border:#cdebe6;--shadow:0 10px 28px rgba(6,107,82,.12);
    --c-sheng:#16a34a;--c-tian:#0ea5b7;--c-yan:#7c3aed;--c-fu:#6b7280;
    --c-huo:#d97706;--c-jue:#ef4444;--c-liu:#f472b6;--c-wu:#111827;
  }
  .dark{--bg:#0b1413;--card:#0f1c1a;--text:#e6fffb;--muted:#8ec1b8;--accent:#23b6af;--border:#143230;--shadow:0 10px 28px rgba(0,0,0,.35)}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
    font-family:"Inter","Noto Sans TC","Microsoft JhengHei",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;line-height:1.6}
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px}
  h1{margin:8px 0 12px;text-align:center;color:var(--accent);font-size:26px;font-weight:800}
  label{display:block;font-size:14px;margin:8px 0 6px;color:var(--muted)}
  input{width:100%;padding:14px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:transparent;color:var(--text)}
  input::placeholder{color:color-mix(in oklab, var(--muted) 60%, transparent)}
  input:focus{outline:none;box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 30%, transparent);border-color:color-mix(in oklab, var(--accent) 40%, var(--border))}
  .row{display:flex;gap:10px;flex-wrap:wrap}.row>*{flex:1 1 260px}
  .btn{padding:13px 16px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn:hover{filter:brightness(.95)} .btn.secondary{background:#0f2a26}
  .muted{color:var(--muted)} .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:color-mix(in oklab, var(--accent) 10%, transparent);color:var(--text);font-size:12px;margin-right:6px}
  .tableWrap{overflow:auto;max-height:58vh;-webkit-overflow-scrolling:touch}
  table{width:100%;border-collapse:collapse;min-width:680px}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:15px;vertical-align:top;background:transparent}
  thead th{position:sticky;top:0;background:var(--card);z-index:1}
  tr:nth-child(2n) td{background:color-mix(in oklab, var(--bg) 60%, #fff 40%)}
  .chip{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-size:12px;color:#fff}
  .chip .dot{width:8px;height:8px;border-radius:50%;background:#fff;opacity:.85}
  .c-sheng{background:var(--c-sheng)} .c-tian{background:var(--c-tian)} .c-yan{background:var(--c-yan)} .c-fu{background:var(--c-fu)}
  .c-huo{background:var(--c-huo)} .c-jue{background:var(--c-jue)} .c-liu{background:var(--c-liu)} .c-wu{background:var(--c-wu)}
  .statRow{display:flex;align-items:center;gap:8px;margin:6px 0}
  .statBar{flex:1;height:10px;border-radius:999px;background:var(--border);overflow:hidden}
  .statBar i{display:block;height:100%}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .kpi .box{flex:1 1 240px;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:color-mix(in oklab, var(--accent) 6%, transparent)}
  .aiTable{border-radius:12px;overflow:hidden;border:1px solid var(--border)}
  .aiTable thead th{background:color-mix(in oklab, var(--accent) 15%, var(--card));font-weight:800}
  .aiTable td.c{width:70px;text-align:center}
  .aiTable .hit{box-shadow:inset 0 0 0 9999px color-mix(in oklab, var(--accent) 10%, transparent)}
  .footer{margin-top:8px;text-align:right;color:var(--muted);font-size:12px}
  .topbar{display:flex;justify-content:flex-end;align-items:center;margin-bottom:8px;gap:10px}
  .switch{position:relative;width:44px;height:26px;background:var(--border);border-radius:999px;cursor:pointer;transition:.2s}
  .knob{position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:var(--card);box-shadow:var(--shadow);transition:.2s}
  .dark .switch{background:#0a332f} .dark .knob{left:21px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="topbar">
      <div class="switch" id="themeSwitch" aria-label="切換主題"><div class="knob"></div></div>
      <div id="themeLabel" class="muted" style="min-width:60px;text-align:right">湖水綠</div>
    </div>
    <h1>[ 易經數字｜純數字版 ]</h1>
    <div class="row">
      <div>
        <label for="numStr">純數字</label>
        <input id="numStr" placeholder="例如 11220587476 或更長的序列">
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="goNum" class="btn">計算（純數字）</button>
      <button id="resetNum" class="btn secondary">重設</button>
    </div>
  </div>

  <!-- 結果 -->
  <div id="resultNum" class="card" style="margin-top:14px;display:none">
    <div id="headlineNum" class="muted"></div>
    <div class="tableWrap" id="tableWrapNum" style="margin-top:8px">
      <table>
        <thead><tr><th style="width:80px">段次</th><th style="width:90px">兩碼</th><th style="width:120px">命名</th><th>說明</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- A~I 建議表 -->
    <h3 style="margin:14px 0 8px">建議表（A~I 類）</h3>
    <div class="tableWrap" style="max-height:none">
      <table class="aiTable">
        <thead>
          <tr><th style="width:60px">類別</th><th style="width:100px">命格</th><th class="c">次數</th><th>說明</th></tr>
        </thead>
        <tbody id="aiBody"></tbody>
      </table>
    </div>

    <!-- 統計 + 結論 -->
    <div class="kpi">
      <div class="box"><div class="muted">主命</div><div id="mainK" style="font-weight:800"></div></div>
      <div class="box"><div class="muted">總段數</div><div id="totalK" style="font-weight:800"></div></div>
      <div class="box" style="flex:2 1 380px">
        <div class="muted">分布</div><div id="distK"></div>
      </div>
    </div>

    <div id="statsNum" style="margin-top:12px"></div>

    <h3 style="margin:14px 0 6px">結論</h3>
    <div id="conclusion" class="card" style="padding:12px"></div>

    <div class="footer">v3・純數字</div>
  </div>
</div>

<script>
/* ========== 顏色與文案 ========== */
const COLOR_CLASS={"生氣":"sheng","天醫":"tian","延年":"yan","伏位":"fu","禍害":"huo","絕命":"jue","六煞":"liu","五鬼":"wu"};
const TRAIT={
  "生氣":"貴人與轉機、新生動能；隨緣開朗，人脈常有意外收穫。",
  "天醫":"傳承與延伸，偏向知識/資源/配置優化，心性重純粹。",
  "延年":"續航與權力，抗壓強、易成為領導與精神指標。",
  "伏位":"謹慎保守、穩定顧家、蓄勢待發；避免拖延而錯失時機。",
  "禍害":"口舌/面子/小人干擾；宜低槓桿、慎言避紛爭。",
  "六煞":"情感/家庭/異性議題干擾；情緒波動時宜保守。",
  "絕命":"大起大落/投資風險/業務財；要嚴控曝險、避免重押。",
  "五鬼":"偏財/業務催財；過多則『財來財去』，要有紀律。"
};

/* ========== 八宅兩碼表（11派） ========== */
const FIELD={
  11:"伏位",19:"延年",14:"生氣",13:"天醫",17:"禍害",16:"六煞",12:"絕命",18:"五鬼",
  22:"伏位",26:"延年",28:"生氣",27:"天醫",23:"禍害",29:"六煞",21:"絕命",24:"五鬼",
  33:"伏位",34:"延年",39:"生氣",31:"天醫",32:"禍害",38:"六煞",37:"絕命",36:"五鬼",
  44:"伏位",43:"延年",41:"生氣",49:"天醫",46:"禍害",47:"六煞",48:"絕命",42:"五鬼",
  66:"伏位",62:"延年",67:"生氣",68:"天醫",64:"禍害",61:"六煞",69:"絕命",63:"五鬼",
  77:"伏位",78:"延年",76:"生氣",72:"天醫",71:"禍害",74:"六煞",73:"絕命",79:"五鬼",
  88:"伏位",87:"延年",82:"生氣",86:"天醫",89:"禍害",83:"六煞",84:"絕命",81:"五鬼",
  99:"伏位",91:"延年",93:"生氣",94:"天醫",98:"禍害",92:"六煞",96:"絕命",97:"五鬼",
};

/* 反查：每個命格有哪些標準兩碼 */
const REVERSE = (() => {
  const map={}; Object.entries(FIELD).forEach(([k,v])=>{ (map[v] ||= []).push(+k); });
  Object.keys(map).forEach(n=> map[n]=Array.from(new Set(map[n])).sort((a,b)=>a-b) );
  return map;
})();

/* ========== 規則（B 版）：0 重複前碼；5 同化下一碼（peek、不吃下一碼） ========== */
function buildPairsFromNumber(numStr){
  const s=(numStr||"").replace(/\D+/g,""); if(!s) return [];
  const MAX=5000; const pairs=[]; let prev=s[0];
  pairs.push(`${prev}${prev}`); // 第一段：dd
  for(let i=1;i<s.length && pairs.length<MAX;i++){
    const ch=s[i]; const oldPrev=prev; let second;
    if(ch==='0'){ second=oldPrev; }                    // 0：重複前碼
    else if(ch==='5'){                                 // 5：同化下一碼（peek）
      const next=(i+1<s.length)?s[i+1]:oldPrev;
      second=/\d/.test(next)?next:oldPrev;
    }else{ second=ch; prev=ch; }                       // 一般：更新 prev
    pairs.push(`${oldPrev}${second}`);
  }
  return pairs;
}

/* ========== 小工具 ========== */
function chip(name){ const cls="c-"+(COLOR_CLASS[name]||"fu"); return `<span class="chip ${cls}"><span class="dot"></span>${name}</span>`; }
function countMode(arr){const m=new Map(); for(const x of arr){m.set(x,(m.get(x)||0)+1)} let best=null,cnt=-1,pos=arr.length; for(let i=0;i<arr.length;i++){const k=arr[i],c=m.get(k); if(c>cnt||(c===cnt&&i<pos)){best=k;cnt=c;pos=i;}} return best;}
function computeStats(names){
  const total=names.length, counts={};
  let cur=null,len=0,start=0,longest={name:null,len:0,start:0,end:0};
  names.forEach((n,i)=>{ counts[n]=(counts[n]||0)+1;
    if(n===cur){len++;}else{ if(len>longest.len)longest={name:cur,len,start,end:i-1}; cur=n; len=1; start=i; }
  });
  if(len>longest.len)longest={name:cur,len,start,end:names.length-1};
  const dist=Object.entries(counts).map(([name,count])=>({name,count,percent:Math.round(count/total*1000)/10})).sort((a,b)=>b.count-a.count);
  return {total,counts,dist,longest,most:(dist[0]?.name||"—")};
}
function renderStats(elId, stats){
  const el=document.getElementById(elId);
  const bars=stats.dist.map(d=>`
    <div class="statRow">
      <span class="pill" style="min-width:56px">${d.name}</span>
      <div class="statBar"><i class="c-${COLOR_CLASS[d.name]||'fu'}" style="width:${d.percent}%;"></i></div>
      <span class="muted" style="min-width:96px;text-align:right">${d.count}（${d.percent}%）</span>
    </div>`).join("");
  el.innerHTML = `<div class="muted" style="margin:4px 0">統計</div>${bars||'<div class="muted">—</div>'}`;
}

/* ========== A~I 建議表 與 動態結論 ========== */
/* A>伏位 B>延年 C>生氣 D>天醫 E>禍害 F>六煞 G>絕命 H>五鬼 I>伏位 */
const AITableRows = [
  ['A','伏位','八字五行相生相剋／平衡力'],
  ['B','延年','錢財延續性'],
  ['C','生氣','靠貴人入財／創造新機運'],
  ['D','天醫','正財運／財庫（亦可解作知識資源與配置優化）'],
  ['E','禍害','因小人／健康或面子問題而破財漏財／以口入財'],
  ['F','六煞','因家人或感情問題而破財漏財／有異性財'],
  ['G','絕命','財運大起大落，或有投資風險／業務財'],
  ['H','五鬼','偏財運／業務催財（過多則財來財去一場空）'],
  ['I','伏位','保守／穩定中求財']
];

function buildConclusion(counts){
  const c = (k)=>counts[k]||0;
  const fv=c('伏位'), en=c('延年'), sq=c('生氣'), ty=c('天醫'), hh=c('禍害'), ls=c('六煞'), jm=c('絕命'), wg=c('五鬼');

  const part=(txt,strong,mid)=> strong>=3 ? `極具${txt}` : (strong>=1 ? `具${txt}` : (mid||'')); // ≥3 強、1~2 有

  const pos = []
  if(fv) pos.push(part('平衡力',fv));
  if(en) pos.push(part('錢財延續性',en));
  if(sq) pos.push(part('貴人/機運',sq));
  if(ty) pos.push(part('正財/財庫（知識配置）',ty));

  const neg = []
  if(hh) neg.push(part('小人/口舌/面子或健康干擾',hh));
  if(ls) neg.push(part('感情與家庭議題干擾',ls));
  if(jm) neg.push(part('波動與投資風險（業務財）',jm));
  if(wg) neg.push(part('偏財過旺、財來財去',wg));

  const posLine = pos.length? `優勢面：${pos.join('、')}。` : '';
  const negLine = neg.length? `留意面：${neg.join('、')}。` : '';

  const tip = `化解與補強方向：優先補「生氣、天醫、延年」，可提升續航與正向動能；負面格（禍害／六煞／絕命／五鬼）出現較多時，建議降低槓桿、控制部位與週期，並避免口舌與情緒交易。`;

  return `${posLine} ${negLine} ${tip}`.trim();
}

function fillAITable(counts){
  const tbody=document.getElementById('aiBody'); tbody.innerHTML='';
  const map = {
    'A':'伏位','B':'延年','C':'生氣','D':'天醫','E':'禍害','F':'六煞','G':'絕命','H':'五鬼','I':'伏位'
  };
  let maxCnt = 0;
  // 找最大值（用於高亮）
  AITableRows.forEach(([k,name]) => { const v = counts[name]||0; if(v>maxCnt) maxCnt=v; });
  AITableRows.forEach(([k,name,desc])=>{
    const v = counts[name]||0;
    const hit = (v===maxCnt && v>0) ? 'hit' : '';
    const cls = COLOR_CLASS[name]||'fu';
    const nums = (REVERSE[name]||[]).join('、') || '—';
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="${hit}">${k}</td>
      <td class="${hit}">${chip(name)}</td>
      <td class="c ${hit}"><b>${v}</b></td>
      <td class="${hit}">${desc}　<span class="muted">（標準數字：${nums}）</span></td>`;
    tbody.appendChild(tr);
  });
}

/* ========== 事件 ========== */
document.getElementById('goNum').addEventListener('click', ()=>{
  const numStr=document.getElementById('numStr').value.trim();
  if(!numStr){ alert('請輸入純數字'); return; }

  const pairs=buildPairsFromNumber(numStr);
  const names=pairs.map(p=>FIELD[p]||"—");

  // 表格
  const tbody=document.getElementById('tbody'); tbody.innerHTML='';
  names.forEach((n,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>第${idx+1}段</td><td>${pairs[idx]}</td><td>${chip(n)}</td><td>${TRAIT[n]||''}</td>`;
    tbody.appendChild(tr);
  });

  // 統計
  const stat=computeStats(names);
  renderStats('statsNum', stat);

  // KPI
  const main=countMode(names);
  const distStr = Object.entries(stat.counts).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}:${v}`).join('　');
  document.getElementById('headlineNum').innerHTML =
    `<span class="pill">純數字推算</span><span class="pill">主命 ${main}</span>`;
  document.getElementById('mainK').textContent = main;
  document.getElementById('totalK').textContent = stat.total;
  document.getElementById('distK').textContent  = distStr || '—';

  // A~I 表格
  fillAITable(stat.counts);

  // 結論
  document.getElementById('conclusion').textContent = buildConclusion(stat.counts);

  document.getElementById('resultNum').style.display='block';
});

document.getElementById('resetNum').addEventListener('click',()=>{
  document.getElementById('numStr').value='';
  document.getElementById('tbody').innerHTML='';
  document.getElementById('resultNum').style.display='none';
});

/* ========== 主題切換 ========== */
const labelEl=document.getElementById('themeLabel'); const switchEl=document.getElementById('themeSwitch');
function setTheme(mode){ if(mode==='dark'){document.body.classList.add('dark');labelEl.textContent='黑色主題';} else{document.body.classList.remove('dark');labelEl.textContent='湖水綠';} localStorage.setItem('iching_theme',mode); }
setTheme(localStorage.getItem('iching_theme')||'light');
switchEl.addEventListener('click',()=>{ const now=document.body.classList.contains('dark')?'light':'dark'; setTheme(now); });
</script>
</body>
</html>
